<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FIBA 3x3 Rules — Full Quiz (150 items)</title>
<style>
  :root{
    --bg:#0e1117; --card:#141925; --ink:#e8edf2; --muted:#9aa3ad;
    --accent:#3874ff; --good:#10b981; --bad:#ef4444;
  }
  html,body{height:100%}
  body{margin:0;background:#0d1117;color:var(--ink);font:16px/1.55 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  h1{font-weight:800;font-size:clamp(20px,2.2vw,28px);letter-spacing:.2px;margin:.2rem 0 1rem}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 30px rgba(0,0,0,.25);border-radius:16px;overflow:hidden}
  .bar{height:6px;background:#2a2f3a}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#3874ff,#5aa3ff,#88b4ff);transition:width .4s ease}
  .q-body{padding:18px 20px 6px 20px}
  .q-meta{display:flex;justify-content:space-between;color:var(--muted);font-size:.92rem;margin-bottom:8px}
  .q-text{font-size:1.12rem;margin:6px 0 12px 0}
  .opts{display:grid;gap:10px;padding:0 20px 6px 20px}
  .opt{display:flex;gap:10px;align-items:flex-start;background:#10141d;border:1px solid rgba(255,255,255,.09);padding:12px;border-radius:12px;cursor:pointer;transition:.18s}
  .opt:hover{transform:translateY(-1px);border-color:#3a4050}
  .opt.correct{border-color:var(--good);color:var(--good)}
  .opt.incorrect{border-color:var(--bad);color:var(--bad)}
  .footer{display:flex;gap:10px;align-items:center;padding:14px 16px;background:#121722;border-top:1px solid rgba(255,255,255,.08)}
  button{border:0;border-radius:12px;padding:11px 16px;font-weight:700;cursor:pointer}
  .ghost{color:var(--ink);background:#1a2130;border:1px solid rgba(255,255,255,.1)}
  .next{background:var(--accent);color:#fff}
  .submit{background:#0ea5e9;color:#fff}
  .hidden{display:none !important}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#18202d;border:1px solid #233047;color:#bcd0ea;border-radius:100px;padding:.2rem .6rem;font-size:.8rem}
  .result{padding:22px}
  .score{font-size:1.4rem;font-weight:800;margin:0 0 10px 0}
  .answersheet{padding:10px 14px 24px}
  .answer-row{display:grid;grid-template-columns:1fr;gap:8px;background:#0f1420;border:1px solid rgba(255,255,255,.08);border-radius:12px;margin:10px 0;padding:12px}
  .good{color:var(--good)} .bad{color:var(--bad)} .muted{color:var(--muted)} .small{font-size:.88rem}
  .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .tag{background:#172131;border:1px solid rgba(255,255,255,.08);color:#bcd0ea;border-radius:999px;padding:.1rem .55rem;font-size:.75rem}
  .grid2{display:grid;grid-template-columns:1fr 320px;gap:16px}
  @media (max-width:900px){.grid2{grid-template-columns:1fr}}
  .summary-box{background:#0f1420;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
  .sumRow{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
  .sumRow:last-child{border:0}
</style>
</head>
<body>
<div class="wrap">
  <h1>FIBA 3x3 Rules — Interactive MCQ Practice (150 questions)</h1>

  <div class="card" id="quiz">
    <div class="bar"><i id="progress"></i></div>
    <div class="q-body">
      <div class="q-meta">
        <div id="qcount" class="pill">Question 1</div>
        <div class="pill"><span id="category">General</span></div>
      </div>
      <div id="qtext" class="q-text">Loading…</div>
    </div>
    <div id="options" class="opts"></div>
    <div class="footer">
      <button id="back" class="ghost" title="Go to previous question">Back</button>
      <button id="next" class="next">Next</button>
      <button id="submit" class="submit hidden">Finish & Summary</button>
      <div style="margin-left:auto" class="muted small">Answer to see the correct rule immediately.</div>
    </div>
  </div>

  <div id="results" class="card hidden">
    <div class="result grid2">
      <div>
        <p class="score" id="scoreline">Score: —</p>
        <div class="summary-box" id="byCat"></div>
        <h3>Answer Review</h3>
        <div class="answersheet" id="answerKey"></div>
      </div>
      <div>
        <h3 style="margin:0 0 6px 0">How you did</h3>
        <div class="summary-box" id="quickStats">
          <div class="sumRow"><span>Total questions</span><b id="statTotal">—</b></div>
          <div class="sumRow"><span>Correct</span><b id="statRight">—</b></div>
          <div class="sumRow"><span>Wrong / blank</span><b id="statWrong">—</b></div>
        </div>
        <p class="muted small" style="margin-top:10px">Tip: Focus your reading on the categories with the highest wrong counts.</p>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   Content source (the text you provided). We parse it into
   atomic rule sentences and generate scenario-based MCQs.
   ============================================================ */
const RULES_TEXT = `
PLAYING COURT AND EQUIPMENT
Playing court
A regular 3x3 playing court shall have a flat, hard surface free from obstructions with dimensions of 15 m in width and 11 m in length measured from the inner edge of the boundary line. The court shall have a regular basketball playing court sized zone, including a free throw line (5.80 m), a 2-point line (6.75 m) and a "no-charge semi-circle" area underneath the basket.
The playing area shall be marked in 3 colours: restricted area and 2-point area in one colour, the remaining playing area in another colour and the out-of-bound area in black. The colours in Diagram 1 are mandatory for the FIBA 3x3 World Cups, FIBA 3x3 Champions Cup, Olympic Games, FIBA 3x3 World Tour and FIBA 3x3 Zone Cups.
At grassroots level, 3x3 can be played anywhere; markings may be adapted to available space, however FIBA 3x3 Official Competitions must fully comply with the above specifications including backstop with the shot clock integrated in the backstop padding.
All lines shall be of the same colour and drawn in a contrasting colour, 5 cm in width and clearly visible.
The playing court shall be limited by the boundary line, consisting of the baseline, endline and the sidelines and these lines are not part of the playing court.
There shall be an additional boundary area of 1 m at the endline, 1.5 m at the sidelines (minimum 1 m if space is limited) and 2 m at the baseline around the playing court.
The scorer's table and its chairs must be placed behind the endline on the lefthand side when facing the basket. In Pro Circuit events with limited space the scorer's table may cut the corner at the endline.
Two seats, one for each team, shall be available beside the scorer’s table for substitutes.
The free-throw line is parallel to the baseline and endline; its farthest edge is 5.80 m from the inner edge of the baseline and it is 3.60 m long. Its midpoint lies on the line joining the midpoint of the endline and baseline.
The rectangular restricted area is limited by the baseline, the extended free-throw line and lines 2.45 m from the midpoint of the baseline terminating at the outer edge of the extended free-throw line; these lines excluding the baseline are part of the restricted area.
Free-throw rebound places are marked along the restricted areas as in Diagram 2.
The 2-point field goal area is the entire floor except the area inside the arc; it is limited by parallel lines 0.90 m from each sideline and an arc with a 6.75 m radius measured from the point beneath the exact centre of the basket; the arc joins the parallel lines. The 2-point line is not part of the 2-point area.
The no-charge semi-circle area is marked by a semi-circle with a 1.25 m radius from the point beneath the basket joined to two 0.375 m lines 1.25 m from that point ending 1.20 m from the baseline; imaginary lines complete the area and the semi-circle line is part of the area.
Required equipment includes backstop unit, backboard, basket with pressure-release ring and net, support structure with padding, 3x3 basketballs, game clock, scoreboard, shot clock, two distinct loud signals (shot clock and scorer/timer), scoresheet, playing floor, playing court and adequate lighting.

TEAMS
A team member is eligible when authorised by the organising body’s regulations including age limits. A team member is entitled to play when entered on the scoresheet before the game and not disqualified. During playing time a team member is a player when on the court and a substitute when off the court; during an interval all eligible members are considered players.
Each team shall consist of no more than 4 team members entitled to play (3 players on the court and 1 substitute). Coaches on the playing court, on the substitute seats or remote coaching are not allowed. A substitute becomes a player after his teammate steps off the court.
Uniforms: shirts and shorts share the same dominant colour front and back; socks are the same dominant colour and visible. Shirts must be numbered front and back with plain, contrasting numbers; back numbers at least 15 cm high, front numbers at least 5 cm high, numbers at least 2 cm wide. Allowed numbers are 0, 00 and 1–99; teammates shall not wear the same number; any advertising or logo is at least 5 cm from the numbers. Teams must have a minimum of two sets of shirts (first named wears light, second wears dark unless both agree to switch).
Other equipment must be appropriate and not provide unfair advantage; players shall not wear dangerous objects. Not permitted: hard guards/casts/braces even if padded, objects that could cut, hair accessories and jewellery. Permitted with conditions: sufficiently padded protective equipment, compression sleeves, headgear without facial coverage or hazardous parts, knee braces if covered, nose protector, safe spectacles, textile wrist/headbands up to 10 cm, taping, ankle braces. All players on a team must use black sleeves/headgear/wristbands/headbands/taping unless in national team events where all must use the same solid colour (black, white or predominant uniform colour). Shoes may be any colour combination but no lights or reflective adornments; no commercial or promotional marks on body or hair unless regulations allow.
Players: Injury — Referees may stop play for injury. If the ball is live the whistle is delayed until a shot, loss of control, withholding of the ball or the ball becomes dead, unless immediate stoppage is needed to protect the player. If the injured player cannot continue immediately (about 15 seconds) or receives treatment, he must be substituted. Substitutes may enter with permission to attend an injured player before substitution. A doctor may enter without permission if immediate treatment is required. A bleeding player must be substituted and may return only after bleeding stops and the wound is securely covered; if recovery happens during a time-out he may continue.

PLAYING REGULATIONS
Regular playing time is one period of 10 minutes; the game clock stops on dead balls and free throws. There is a 1-minute interval between regular time and overtime. An interval begins at player introductions (or when players enter) and when the game clock sounds to end regulation if overtime is needed. It ends when the ball is in the offensive player’s hands after the check-ball is completed to start play. If tied at the end of regulation, overtime is played; the first team to score 2 points in overtime wins. If a foul occurs as the horn sounds to end regulation, any free throws are administered after regulation; if overtime is required as a result, fouls after regulation are considered during an interval and free throws are administered before overtime begins. If a game clock is not available, the organiser sets running time and a score limit; FIBA recommends aligning score limits with duration (10 minutes/10 points; 15 minutes/15 points; 21 minutes/21 points).
Both teams warm up simultaneously. A coin flip determines first possession; the winner may choose to start the game or a potential overtime with the ball. The game cannot begin if a team is not on court with 3 players ready to play (official competitions). Playing time or overtime begins when the ball is in the offensive player’s hands after the check-ball is completed. Regulation ends at the horn or when a team reaches 21 or 22 points in regulation (sudden death), whichever comes first. Overtime ends as soon as one team scores 2 or more points.
Status of the ball — The ball is live: after a completed check-ball exchange; following each successful field goal or last free throw; and when a free throw is at the shooter’s disposal. The ball becomes dead when: a referee whistles while the ball is live; it is apparent a free throw will not enter and another free throw/penalty follows; the game-clock signal sounds for end of regulation, sudden death or overtime; the shot-clock signal sounds while a team controls the ball; or the ball in flight is touched after a whistle or horn. The ball does not become dead and the goal counts if the ball is in flight and a whistle/horn sounds or a whistle for an infraction not by the free-throw shooter occurs; or if a player finishes a continuous-motion try that began before a foul on any opponent (with exceptions).
Location — A player’s location is where he touches the floor; while airborne he retains his prior status including boundary lines and markings. Same for referees; the ball touching a referee equals the floor at that spot.
Jump ball situation — A held ball is when opponents have firm hands on the ball so neither can gain control without roughness. Jump-ball situations occur (list) and are resumed with a check-ball for the last defensive team with 12 seconds.
How the ball is played — The ball is played with the hand(s) only. A player shall not run with the ball, deliberately kick or block it with the leg, or strike it with the fist. Accidental leg contact is not a violation.
Control of the ball — Team control starts when a player controls a live ball or has it at his disposal, continues while that team controls or passes the ball, and ends when the opponent gains control, the ball becomes dead, or the ball has left the shooter’s hands.
Player in the act of shooting — Definitions and when the act starts/ends; there is no relationship between number of steps and the act. Arms held may still be a shooting foul even if the ball does not leave the hands. Passing off after the foul ends the act.
Goal: when made and its value — A goal is made when a live ball enters from above and remains or passes through; within basket definition; scoring values: free throw 1 point, inside arc 1 point, behind arc 2 points. Defensive deflections/taps directly into the basket are credited to the last offensive controller (1 or 2 depending on location). Defensive accidental score counts for offense; deliberate defensive score is a violation and does not count; resume with check-ball for last offense. Goals without clearing after defensive control are cancelled. Causing the ball to pass upward through the basket from below is a violation. 0.3 seconds or more are required to control and attempt a shot; at 0.2 or 0.1 only a direct tap is valid.
Check-ball — Possession after dead balls starts with a check-ball: the defensive player hands or bounces the ball to the offensive player behind the arc at the top. Opponents should be about 1 m apart (in world events the infinity logo helps position). If players are not in correct position the referee will pass the ball to the defensive player to execute correctly. The referee administers the opening and overtime check-balls.
Time-out — Each team is granted 1 time-out. In official competitions or if decided by the organiser there are two 30-second TV time-outs at the first dead ball after 6:59 and 3:59. Only at dead-ball opportunities before a check-ball or free throw can time-outs be granted; an unused time-out may be carried to overtime.
Substitution — Either team may substitute when the ball is dead before a check-ball or free throw. Substitutes may enter from behind the endline without prior notice while the clock is stopped; no beckoning needed. If the free-throw shooter must be substituted due to injury or disqualification, his substitute attempts the free throws.
Game lost by forfeit — If at the scheduled start a team is not present with 3 players ready (not mandatory for grassroots) it forfeits. Score recorded w–0 or 0–w; winner’s average score ignores the game, loser’s counts as 0; tortuous forfeit disqualifies the team; a second forfeit or no-show in pool play causes disqualification and removal from final standings.
Game lost by default — A team loses by default if it leaves the court before the end or all its players are injured/disqualified. The winner may keep the score or have a forfeit while the defaulting team’s score is set to 0.
VIOLATIONS
Out-of-bounds — Definitions; the ball is caused out by the last player to touch it. Moving out-of-bounds during a held ball creates a jump-ball situation.
Dribbling — Definitions; carrying prohibition; throwing the ball in the air allowed if it touches the floor or another player first; successive shots, fumbling, taps, deflections, toss hand-to-hand, or throw against backboard are not dribbles. No second dribble unless the player lost control due to a shot, an opponent’s touch, or a pass/fumble touched by another player.
Travelling — Definitions including pivot rules and two-step rule; legal slide to the floor while holding; rolling or standing up with the ball is a violation.
3 seconds — No more than 3 consecutive seconds in the restricted area while in team control with the clock running, with allowances for leaving, during shooting, or dribbling to shoot. To be outside, both feet must be outside.
5 seconds — A closely guarded player (within 1 m) must pass, shoot or dribble within 5 seconds.
Back to the basket — After clearing the ball, an offensive player shall not dribble inside the arc with his back or side to the basket for more than 3 consecutive seconds.
12 seconds — Team must attempt a shot within 12 seconds when gaining control, after a completed check-ball, or after a successful basket when the non-scoring team has the ball. Definition of a try near 12 seconds; ring touch outcomes; disregard if opponents gain immediate clear control. Shot-clock reset rules (full list) and special cases (technical foul no reset, USF/DQF reset, jump-ball reset, ring touch reset, erroneous signal handling). If no shot clock, referees count the last 5 seconds with voice and arm.
Clearing the ball — After a successful goal or last free throw (except followed by possession) the non-scoring team must take the ball from directly under the basket (inside the court) and clear behind the arc; defense may not play for the ball in the no-charge semi-circle. After an unsuccessful try: offensive rebound may continue to score; defensive rebound must clear behind the arc; steals/blocks must also clear. A shot attempted before clearance is a “no-cleared ball” violation; cancel basket and award check-ball to opponents.
Goaltending & Interference — Definitions and restrictions; defensive goaltending awards points (1 on free throw, 1 inside arc, 2 behind arc); offensive violation awards ball to opponents; last-free-throw goaltending by defense also triggers a technical foul.
FOULS
Definitions; cylinder and verticality principles; legal guarding position; guarding with and without the ball (time/distance on off-ball); airborne player rights; screening legal/illegal; charging, blocking, extended arms/elbows; no-charge semi-circle interpretations; hand/arm contact guidelines including hooking and pushing-off; post play; illegal guarding from rear; holding; pushing; fake being fouled.
Contact foul — Penalties: not in act—check-ball (2 FT from 7th team foul); in act—values depending on success/location; horn-timing special case. Double foul — definition, conditions and resumption. Technical foul — behaviour list; penalty 1 FT and resume with prior entitlement; counts as team foul. Unsportsmanlike foul — excessive/hard/dangerous; first USF: 2 FT (goal + 2 FT if made), second USF: 2 FT + possession; counts as 2 team fouls; disqualification on 2 USF. Disqualifying foul — flagrant behaviour; penalties 2 FT to offended player (or any opponent for non-contact) then check-ball; all DQF count as 2 team fouls; organiser may further disqualify. Fighting — substitutes who leave the bench are disqualified unless assisting referees; resumptions by context; counts as 2 team fouls.
Team fouls: penalty — 7–9: 2 FT; 10+: 2 FT and possession; also for USF and shooting fouls; team-control foul: check-ball.
Special situations — ordering/cancelling equal penalties; how to resume; technical foul administered first; last penalty’s possession cancels prior rights; once ball is live first penalty can’t cancel remaining. Free throws — who shall shoot; shooter’s restrictions (position, release within 5 seconds, no fake, etc.); players’ positions and restrictions; penalties for violations.
Correctable errors category 1 and 2 — lists and procedures (who may stop, when still correctable, how to resume, what to cancel/correct, clock corrections).
REFEREES, TABLE OFFICIALS, SPORTS SUPERVISOR
Two referees assisted by table officials and sports supervisor; duties and powers of sports supervisor; referees’ powers including IRS/Challenge procedures and language; scorer/scoreboard operator/shot-clock operator duties (what to start/stop/reset).
`;

/* =============== Utilities =============== */
const shuffle = a => { for (let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; };
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

/* Extract category blocks (a very light-weight parser) */
function parseRulesBlocks(text){
  const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
  const items=[];
  let cat="General";
  for (let line of lines){
    if (/^[A-Z][A-Z \-:&()']{3,}$/.test(line) && line.length<80){ cat=line; continue; }
    // split bullets too
    if (line.startsWith('•')) line=line.replace(/^•\s*/,'');
    // break long paragraphs into shorter sentences by '.' while keeping numbers like 6.75 m intact.
    const split = line.split(/(?<=[^.0-9])\.\s+/).map(s=>s.trim()).filter(s=>s && s.length>20);
    for(const s of split){ items.push({cat, sentence: s.endsWith('.')?s:s+'.'}); }
  }
  return items;
}

/* Build 150 unique rule statements (one per paragraph-ish) */
const ALL_SENTENCES = parseRulesBlocks(RULES_TEXT);

// Deduplicate identical sentences
const SEEN = new Set(); 
const UNIQUE = [];
for(const it of ALL_SENTENCES){
  const key = it.cat+'::'+it.sentence;
  if(!SEEN.has(key)){ SEEN.add(key); UNIQUE.push(it); }
}

/* Create scenario stem from a rule sentence */
function scenarioFromSentence(s){
  // lightweight scenario generator
  if (/\b(\d+(?:\.\d+)?)\s*(m|cm|minutes|minute|seconds|second|points?)\b/i.test(s)){
    return "In game administration, which statement applies in this situation regarding measurements or timing?";
  }
  if (/shall be awarded|awarded|penalized|penalised/i.test(s)) {
    return "A referee needs the correct penalty. Which rule statement applies?";
  }
  if (/must|shall|may not|is not|are not/i.test(s)) {
    return "Select the rule that governs this situation.";
  }
  return "Which official 3x3 rule applies to the described situation?";
}

/* Make 3 relevant but distinct distractors */
function makeDistractors(correct){
  const ds = [];
  // numeric tweak
  const numRe = /(\d+(?:\.\d+)?)(\s*(?:m|cm|minutes|minute|seconds|second|points?))/ig;
  if (numRe.test(correct)){
    let base = correct;
    let idx = 0;
    base.replace(numRe, (_m,n,u)=>{
      const v = parseFloat(n);
      const variants = [v+1, Math.max(0, v-1), v===12?14: (v===6.75?6.25:v+0.5)];
      const choice = variants[idx%variants.length]; idx++;
      return choice + u;
    });
    ds.push(correct.replace(numRe, (m,n,u)=> (parseFloat(n)+1)+u));
    ds.push(correct.replace(numRe, (m,n,u)=> (Math.max(0,parseFloat(n)-1))+u));
    ds.push(correct.replace(numRe, (m,n,u)=> {
      const v=parseFloat(n);
      if(u.trim()==='m'){ return (v===6.75?6.25:6.75)+' m'; }
      if(/seconds?/.test(u)) return (v===5?7:5)+' seconds';
      if(/minutes?/.test(u)) return (v===10?8:10)+' minutes';
      if(/points?/.test(u)) return (v===2?3:2)+' points';
      return (v+2)+u;
    }));
  }
  // wording flip
  const flips = [
    c=>c.replace(/\bshall not\b/gi,'may').replace(/\bmust not\b/gi,'may'),
    c=>c.replace(/\bshall\b/gi,'may'),
    c=>c.replace(/\bmay\b/gi,'shall not')
  ];
  for(const f of flips){
    const t=f(correct);
    if (t!==correct) ds.push(t);
    if (ds.length>=3) break;
  }
  // pull other-category statements if still short
  while (ds.length<3){
    const pick = UNIQUE[Math.floor(Math.random()*UNIQUE.length)].sentence;
    if (!ds.includes(pick) && pick!==correct) ds.push(pick);
  }
  // trim and ensure end period
  return ds.slice(0,3).map(x=>x.trim().replace(/\s+/g,' ').replace(/\.*$/,'.'));
}

/* Build MCQ items (150 total) */
function buildQuestions(){
  // We will take the first 150 unique rule statements that are declarative (contain shall / must / is / are).
  const base = UNIQUE.filter(x=>/[A-Z]/.test(x.sentence) && /(?:shall|must|may|is|are|cannot|can|counts?)/i.test(x.sentence));
  // ensure we have at least 150
  const chosen = base.slice(0, 150);
  return chosen.map((it, idx)=>{
    const correct = it.sentence.trim();
    const stem = scenarioFromSentence(correct);
    const distractors = makeDistractors(correct);
    const options = shuffle([correct, ...distractors]);
    return {
      id:`Q${idx+1}`, type:"text", cat:it.cat, stem,
      q: stem, rule: correct, options,
      answer: options.indexOf(correct)
    };
  });
}

/* ============================================================
   Runtime (150 items, shuffled order & options)
   ============================================================ */
let QUESTIONS = buildQuestions();
QUESTIONS = shuffle(QUESTIONS).map(q=>({ ...q, options: shuffle(q.options) }));

const TOTAL = QUESTIONS.length; // 150
const RUN = { order: QUESTIONS, answers: Array(TOTAL).fill(null), i: 0, score: 0, wrongByCat: {} };

const $qtext = document.getElementById("qtext");
const $opts  = document.getElementById("options");
const $next  = document.getElementById("next");
const $back  = document.getElementById("back");
const $submit= document.getElementById("submit");
const $qcount= document.getElementById("qcount");
const $cat   = document.getElementById("category");
const $prog  = document.getElementById("progress");

function render(i){
  const q = RUN.order[i];
  $qcount.textContent = `Question ${i+1} / ${TOTAL}`;
  $cat.textContent = q.cat || "General";
  // Display scenario + add a small hint tag telling it's an application scenario
  $qtext.innerHTML = `${q.stem}`;
  $opts.innerHTML = "";

  q.options.forEach((opt,idx)=>{
    const div = document.createElement("label");
    div.className = "opt";
    div.innerHTML = `<input type="radio" name="q${i}" style="margin-top:2px"> <span>${opt}</span>`;
    div.addEventListener("click",()=>{
      if(RUN.answers[i]!=null) return; // lock after answering
      RUN.answers[i]=idx;
      const ok = (idx===q.answer);
      if(ok){ div.classList.add("correct"); RUN.score++; }
      else{
        div.classList.add("incorrect");
        // mark the correct one
        [...$opts.children].forEach((c,j)=>{ if(j===q.answer) c.classList.add("correct"); });
        // count by category
        RUN.wrongByCat[q.cat] = (RUN.wrongByCat[q.cat]||0)+1;
      }
      // Immediate reveal of the exact rule sentence (required)
      const reveal = document.createElement('div');
      reveal.className = ok ? "good small" : "bad small";
      reveal.style.marginTop = "6px";
      reveal.innerHTML = `<b>${ok?"Correct":"Correct rule"}:</b> ${q.options[q.answer]}`;
      $opts.appendChild(reveal);
    });
    $opts.appendChild(div);
  });

  $back.disabled = i===0;
  $next.classList.toggle("hidden", i===TOTAL-1);
  $submit.classList.toggle("hidden", i!==TOTAL-1);
  $prog.style.width = `${(i)/TOTAL*100}%`;
}
$next.addEventListener("click", ()=>{ RUN.i=Math.min(TOTAL-1,RUN.i+1); render(RUN.i); });
$back.addEventListener("click", ()=>{ RUN.i=Math.max(0,RUN.i-1); render(RUN.i); });
$submit.addEventListener("click", finish);

/* -------- Summary -------- */
function finish(){
  const container = document.getElementById("quiz");
  const results = document.getElementById("results");
  container.classList.add("hidden");
  results.classList.remove("hidden");
  document.getElementById("progress").style.width="100%";

  const keyEl = document.getElementById("answerKey");
  keyEl.innerHTML = "";

  let correct = 0;
  const byCatCount = {};
  const byCatWrong = {};

  RUN.order.forEach((q,idx)=>{
    const chosen = RUN.answers[idx];
    const okIdx  = q.answer;
    const ok = (chosen===okIdx);
    if(ok) correct++;
    byCatCount[q.cat]=(byCatCount[q.cat]||0)+1;
    if(!ok) byCatWrong[q.cat]=(byCatWrong[q.cat]||0)+1;

    const row = document.createElement("div");
    row.className = "answer-row";
    row.innerHTML = `
      <div><strong>Q${idx+1}</strong> <span class="tag">${q.cat}</span></div>
      <div>${q.stem}</div>
      <div><span class="good"><b>Correct rule:</b></span> ${q.options[okIdx]}</div>
      <div><span class="${ok?'good':'bad'}"><b>Your answer:</b></span> ${chosen!=null ? q.options[chosen] : "(no answer)"} </div>
    `;
    keyEl.appendChild(row);
  });

  document.getElementById("scoreline").textContent = `Score: ${correct} / ${TOTAL}`;
  document.getElementById("statTotal").textContent = TOTAL;
  document.getElementById("statRight").textContent = correct;
  document.getElementById("statWrong").textContent = TOTAL - correct;

  // Category summary: where to read more
  const byCatDiv = document.getElementById("byCat");
  byCatDiv.innerHTML = "<h3 style='margin:4px 0 8px 0'>Topics to review</h3>";
  const cats = Object.keys(byCatCount).sort((a,b)=>(byCatWrong[b]||0)-(byCatWrong[a]||0));
  cats.forEach(c=>{
    const wrong = byCatWrong[c]||0;
    const total = byCatCount[c]||0;
    const pct = Math.round((wrong/total)*100);
    const line = document.createElement('div');
    line.className = 'sumRow';
    line.innerHTML = `<span>${c}</span><b>${wrong} wrong / ${total} (${pct}%)</b>`;
    byCatDiv.appendChild(line);
  });
}

/* -------- Start -------- */
render(0);
</script>
</body>
</html>