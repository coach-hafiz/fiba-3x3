<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FIBA 3x3 MCQ Quiz — Stable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0e1117; --panel:#161b22; --ink:#e6edf3; --muted:#9da7b3; --accent:#f6c945; --good:#2ea043; --bad:#f85149; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{padding:14px 18px;border-bottom:1px solid #232a34;background:linear-gradient(180deg,#0f1320,#0e1117);display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:18px}
    .reset{background:#0b1320;border:1px solid #243044;color:#c8d1dc;border-radius:8px;padding:8px 10px;font-weight:600;cursor:pointer}
    main{max-width:960px;margin:0 auto;padding:18px}
    .card{background:var(--panel);border:1px solid #232a34;border-radius:12px;padding:18px;box-shadow:0 6px 24px rgba(0,0,0,.20)}
    .meta{display:flex;gap:12px;align-items:center;margin:8px 0 14px;color:var(--muted);font-size:13px}
    .pill{display:inline-block;background:#111826;border:1px solid #233043;border-radius:999px;padding:6px 10px}
    .progress-wrap{height:8px;background:#0b0f16;border-radius:999px;overflow:hidden;border:1px solid #1f2630;flex:1}
    .progress{height:100%;background:linear-gradient(90deg,var(--accent),#ffd86b);width:0%}
    .q-text{font-size:18px;margin:10px 0 14px}
    .options{display:grid;gap:10px}
    .opt{border:1px solid #2a3442;border-radius:10px;padding:12px 14px;cursor:pointer;background:#111826;transition:transform .05s ease,border-color .2s}
    .opt:hover{transform:translateY(-1px)}
    .opt.selected{outline:2px solid #39506b}
    .opt.correct{border-color:var(--good);background:rgba(46,160,67,.12)}
    .opt.incorrect{border-color:var(--bad);background:rgba(248,81,73,.10)}
    .feedback{margin-top:10px;font-size:14px}
    .feedback.good{color:var(--good)} .feedback.bad{color:var(--bad)}
    .controls{display:flex;justify-content:space-between;gap:10px;margin-top:18px}
    button{background:#1f6feb;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:#0b1320;border:1px solid #243044;color:#c8d1dc}
    button:disabled{opacity:.6;cursor:not-allowed}
    .img-wrap{display:flex;justify-content:center;margin:6px 0 12px}
    .img-wrap img{max-width:360px;max-height:220px;width:auto;height:auto;border-radius:10px;border:1px solid #273244;background:#0b0f16}
    .summary h2{margin-top:0}
    .summary .badlist{margin:10px 0 0;padding-left:18px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    details{border:1px dashed #2a3442;border-radius:10px;padding:10px;margin-top:10px}
    details summary{cursor:pointer;color:#d2dbe7}
    .foot{margin-top:18px;color:var(--muted);font-size:12px}
    .alert{padding:10px;border-radius:8px;border:1px solid #3b2b17;background:#17120b;color:#fff;margin-bottom:12px}
  </style>
</head>
<body>
  <header>
    <h1>FIBA 3x3 Quiz</h1>
    <button class="reset" id="resetBtn">Reset quiz</button>
  </header>

  <main>
    <div id="warnBox" class="alert" style="display:none"></div>

    <div class="card">
      <div class="meta">
        <span class="pill" id="catPill">Category</span>
        <div class="progress-wrap"><div class="progress" id="progress"></div></div>
        <span class="pill" id="countPill">Q 1/1</span>
      </div>

      <div id="imageZone" class="img-wrap" style="display:none"></div>
      <div class="q-text" id="qText">Loading…</div>
      <div class="options" id="options"></div>
      <div id="feedback" class="feedback"></div>

      <div class="controls">
        <button id="backBtn" class="secondary">← Back</button>
        <div style="display:flex;gap:10px">
          <button id="nextBtn">Next →</button>
          <button id="finishBtn" style="display:none">Finish</button>
        </div>
      </div>

      <section id="summary" class="summary" style="display:none;margin-top:8px">
        <h2>Summary</h2>
        <p>Total: <b id="sumTotal">0</b> · Correct: <b id="sumCorrect">0</b> · Wrong: <b id="sumWrong">0</b></p>
        <details open>
          <summary>Wrong questions & explanations</summary>
          <ol id="wrongList" class="badlist"></ol>
        </details>
        <details>
          <summary>Rule categories to review</summary>
          <ul id="catList" class="badlist"></ul>
        </details>
        <div class="foot">Your answers are saved locally. Use “Reset quiz” to clear & reshuffle.</div>
      </section>
    </div>

    <!-- Paste your FULL rules text between these tags -->
    <script type="text/plain" id="rules">
PLAYING COURT AND EQUIPMENT
(keep your full text here; I left only the heading so this demo loads. The generator works best with the full paste.)
    </script>

    <script>
    (function(){
      // ---------- SAFE UTILITIES ----------
      const warnBox = document.getElementById('warnBox');
      function showWarn(msg){
        warnBox.textContent = msg;
        warnBox.style.display = 'block';
      }
      function tryLocalStorage(){
        try{
          const k='__t'; localStorage.setItem(k,'1'); localStorage.removeItem(k);
          return localStorage;
        }catch(e){ return null; }
      }
      const LS = tryLocalStorage();
      if(!LS){ showWarn('Note: Your browser blocked local storage. Answers will not persist after closing the tab.'); }

      function safePRNG(seed){
        // Mulberry32 – tiny, stable
        let t = seed >>> 0;
        return function(){
          t += 0x6D2B79F5;
          let r = Math.imul(t ^ t>>>15, 1 | t);
          r ^= r + Math.imul(r ^ r>>>7, 61 | r);
          return ((r ^ r>>>14) >>> 0) / 4294967296;
        };
      }
      function getSeed(){
        try{
          if (window.crypto && crypto.getRandomValues){
            return (crypto.getRandomValues(new Uint32Array(1))[0]>>>0) || (Date.now()>>>0);
          }
        }catch(e){}
        return (Date.now()>>>0);
      }
      function shuffleInPlace(a, rnd){
        for(let i=a.length-1;i>0;i--){ const j = Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
        return a;
      }
      function hashString(s){
        let h=2166136261>>>0;
        for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h,16777619); }
        return (h>>>0).toString(16);
      }
      function escapeRegex(x){ return x.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

      // ---------- CONFIG: Add signal images (filenames become answers) ----------
      const signalImages = [
        // "signals/travelling.png",
        // "signals/charging.jpg",
        // "signals/blocking.png",
        // "signals/unsportsmanlike.png",
        // "signals/technical.png"
      ];

      // ---------- PARSE RULES ----------
      const rulesText = document.getElementById('rules').textContent.trim();
      const RULES_HASH = hashString(rulesText + JSON.stringify(signalImages));

      function isHeading(line){
        if(!line) return false;
        const s = line.trim();
        const noDot = !/[.!?]$/.test(s);
        const capsish = /^[A-Z0-9 .:;'()/-]+$/.test(s);
        const lenOK = s.length <= 42;
        return (capsish && lenOK) || (noDot && lenOK && /^[A-Z]/.test(s));
      }
      function parseRules(raw){
        const lines = raw.split(/\r?\n/);
        const categories = [];
        const catMap = {};
        let current = null, buf = [];
        const flush = ()=>{
          const para = buf.join(' ').trim();
          if(para && current){ (catMap[current] ??= []).push(para); }
          buf = [];
        };
        for(const L of lines){
          const line = (L||'').replace(/\s+$/,'');
          if(isHeading(line)){
            if(buf.length && current) flush();
            current = line.trim().replace(/\s+/g,' ').toUpperCase();
            if(!categories.includes(current)) categories.push(current);
          } else if(line.trim()===''){
            if(buf.length) flush();
          } else {
            buf.push(line.trim());
          }
        }
        if(buf.length && current) flush();
        return {categories, catMap};
      }
      function concise(p){
        let s = p.replace(/\s+/g,' ').trim();
        s = s.replace(/\(Diagram[^)]+\)/gi,'').replace(/\(see[^)]+\)/gi,'');
        if(s.length>320){ s = s.slice(0,300).replace(/[,;:]?\s+\S+$/,'') + '…'; }
        return s;
      }

      // ---------- RELEVANT DISTRACTORS (controlled single-change) ----------
      const TERM_MAP = [
        ['inside the arc','behind the arc'],
        ['behind the arc','inside the arc'],
        ['restricted area','no-charge semi-circle area'],
        ['no-charge semi-circle area','restricted area'],
        ['baseline','endline'],
        ['endline','baseline'],
        ['sidelines','baseline'],
        ['free throw','field goal'],
        ['field goal','free throw'],
        ['offensive','defensive'],
        ['defensive','offensive'],
        ['live ball','dead ball'],
        ['dead ball','live ball'],
        ['1 point','2 points'],
        ['2 points','1 point'],
        ['12 seconds','10 seconds'],
        ['10 minutes','12 minutes'],
      ];
      function firstVariant(s){
        for(const [a,b] of TERM_MAP){
          const re = new RegExp(`\\b${escapeRegex(a)}\\b`,'i');
          if(re.test(s)) return {from:a,to:b};
        }
        return null;
      }
      function tweakNumber(s){
        let m = s.match(/(\d+(?:\.\d+)?)\s?m\b/i);
        if(m){
          const num = parseFloat(m[1]);
          const alt = Math.max(0.1, +(num * 1.15).toFixed(2));
          return s.replace(m[0], `${alt} m`);
        }
        m = s.match(/\b(\d{1,2})\s?seconds?\b/i);
        if(m){
          const v = Math.max(1, parseInt(m[1],10) + 2);
          return s.replace(m[0], `${v} seconds`);
        }
        m = s.match(/\b(\d{1,2})\s?minutes?\b/i);
        if(m){
          const v = Math.max(1, parseInt(m[1],10) + 2);
          return s.replace(m[0], `${v} minutes`);
        }
        m = s.match(/\b(1|2)\s?points?\b/i);
        if(m){
          const alt = m[1]==='1' ? '2 points' : '1 point';
          return s.replace(m[0], alt);
        }
        return null;
      }
      function makeRelevantDistractors(correct, need, rnd){
        const out = new Set();
        let guard = 0;
        while(out.size < need && guard < 80){
          let c = correct;
          if(rnd() < 0.6){
            const numT = tweakNumber(c);
            if(numT) c = numT;
            else {
              const v = firstVariant(c);
              if(v) c = c.replace(new RegExp(`\\b${escapeRegex(v.from)}\\b`,'i'), v.to);
              else c = c.replace(/\bshall\b/ig,'must'); // gentle phrasing only
            }
          } else {
            const v = firstVariant(c);
            if(v) c = c.replace(new RegExp(`\\b${escapeRegex(v.from)}\\b`,'i'), v.to);
            else {
              const numT = tweakNumber(c);
              if(numT) c = numT;
            }
          }
          if(c !== correct && Math.abs(c.length - correct.length) <= Math.max(12, correct.length*0.3)){
            out.add(c);
          }
          guard++;
        }
        // fallback: ensure we have exactly 'need'
        const list = Array.from(out);
        while(list.length < need){
          const v = firstVariant(correct);
          if(v){
            const c2 = correct.replace(new RegExp(`\\b${escapeRegex(v.from)}\\b`,'i'), v.to);
            if(c2 !== correct && !list.includes(c2)) list.push(c2);
          } else {
            const m = correct.match(/\b(\d{1,2})\s?seconds?\b/i);
            if(m){
              const base = parseInt(m[1],10);
              const alt = `${base+ (list.length%2?1:-1)} seconds`;
              const c2 = correct.replace(m[0], alt);
              if(c2 !== correct && !list.includes(c2)) list.push(c2);
            } else break;
          }
        }
        return list.slice(0, need).map(t => ({t, ok:false}));
      }

      // ---------- BUILD QUESTIONS ----------
      function buildQuestions(rnd){
        const {categories, catMap} = parseRules(rulesText);
        const qs = [];
        for(const cat of categories){
          const paras = (catMap[cat]||[]).filter(p=>/\w/.test(p));
          for(const p of paras){
            const stem = concise(p);
            if(stem.length < 15) continue;
            const prompt = `Scenario (${cat}): Which option best reflects this rule in play?`;
            const correct = stem;
            const distractors = makeRelevantDistractors(correct, 4, rnd);
            const options = [{t:correct, ok:true}, ...distractors];
            shuffleInPlace(options, rnd);
            qs.push({ type:'rule', category:cat, paragraph:p, prompt, options,
              explain:`Rule reference: <span class="mono">${correct}</span>` });
          }
        }
        if(signalImages.length){
          const names = signalImages.map(s=>s.split('/').pop().replace(/\.[a-z0-9]+$/i,''));
          for(const src of signalImages){
            const ans = src.split('/').pop().replace(/\.[a-z0-9]+$/i,'');
            const pool = names.filter(n=>n!==ans); shuffleInPlace(pool, rnd);
            const opts = [{t:ans, ok:true}, ...pool.slice(0,4).map(t=>({t, ok:false}))];
            shuffleInPlace(opts, rnd);
            qs.push({ type:'signal', category:'REFEREE HAND SIGNALS', image:src,
              prompt:'Referee Signal: Identify the correct name.', options:opts,
              explain:`Answer is the filename: <span class="mono">${ans}</span>` });
          }
        }
        shuffleInPlace(qs, rnd);
        return qs;
      }

      // ---------- SESSION (persistent) ----------
      const STORAGE_KEY = 'fiba3x3_quiz_stable_v1';
      function loadSession(){
        if(!LS) return null;
        try{
          const raw = LS.getItem(STORAGE_KEY);
          if(!raw) return null;
          const s = JSON.parse(raw);
          if(!s || s.rulesHash !== RULES_HASH) return null;
          return s;
        }catch(e){ return null; }
      }
      function saveSession(s){ if(LS){ try{ LS.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){} } }
      function clearSession(){ if(LS){ try{ LS.removeItem(STORAGE_KEY); }catch(e){} } }

      let session = loadSession();
      if(!session){
        const seed = getSeed();
        const rnd = safePRNG(seed);
        const questions = buildQuestions(rnd);
        session = {
          rulesHash: RULES_HASH,
          seed,
          i: 0,
          questions,
          answers: Array(questions.length).fill(null),
          correctness: Array(questions.length).fill(null),
          finished: false
        };
        saveSession(session);
      }
      const rnd = safePRNG(session.seed);

      // ---------- UI ----------
      const qText = document.getElementById('qText');
      const optionsEl = document.getElementById('options');
      const feedbackEl = document.getElementById('feedback');
      const imageZone = document.getElementById('imageZone');
      const backBtn = document.getElementById('backBtn');
      const nextBtn = document.getElementById('nextBtn');
      const finishBtn = document.getElementById('finishBtn');
      const catPill = document.getElementById('catPill');
      const countPill = document.getElementById('countPill');
      const progressBar = document.getElementById('progress');
      const resetBtn = document.getElementById('resetBtn');

      const summaryBox = document.getElementById('summary');
      const sumTotal = document.getElementById('sumTotal');
      const sumCorrect = document.getElementById('sumCorrect');
      const sumWrong = document.getElementById('sumWrong');
      const wrongList = document.getElementById('wrongList');
      const catList = document.getElementById('catList');

      function render(){
        const total = session.questions.length;
        if(total === 0){
          qText.textContent = 'No questions generated. Paste full rules text into the page.';
          document.querySelector('.controls').style.display = 'none';
          return;
        }
        const idx = Math.max(0, Math.min(session.i, total-1));
        const q = session.questions[idx];

        catPill.textContent = q.category;
        countPill.textContent = `Q ${idx+1}/${total}`;
        progressBar.style.width = `${(idx/total)*100}%`;

        qText.innerHTML = q.prompt;

        imageZone.style.display = (q.type==='signal') ? 'flex' : 'none';
        imageZone.innerHTML = '';
        if(q.type==='signal'){
          const img = document.createElement('img');
          img.alt = 'Referee Signal';
          img.src = q.image;
          imageZone.appendChild(img);
        }

        optionsEl.innerHTML = '';
        feedbackEl.textContent = '';
        const prev = session.answers[idx];

        q.options.forEach((opt, k)=>{
          const div = document.createElement('div');
          div.className = 'opt';
          div.setAttribute('role','button');
          div.setAttribute('tabindex','0');
          div.innerHTML = `<b>${String.fromCharCode(65+k)}.</b> ${opt.t}`;

          div.addEventListener('click',()=>{
            session.answers[idx] = k;
            const ok = q.options[k].ok===true;
            session.correctness[idx] = ok;
            saveSession(session);

            [...optionsEl.children].forEach(c=>c.classList.remove('selected','correct','incorrect'));
            div.classList.add('selected');
            if(ok){
              div.classList.add('correct');
              feedbackEl.className = 'feedback good';
              feedbackEl.textContent = '✔ Correct!';
            } else {
              div.classList.add('incorrect');
              feedbackEl.className = 'feedback bad';
              feedbackEl.innerHTML = `✖ Incorrect. ${q.explain}`;
              // show correct
              [...optionsEl.children].forEach((c,ci)=>{ if(q.options[ci].ok) c.classList.add('correct'); });
            }
          });

          optionsEl.appendChild(div);
        });

        // Reapply saved selection & feedback
        if(prev !== null){
          const ok = session.correctness[idx] === true;
          const chosen = optionsEl.children[prev];
          if(chosen){
            chosen.classList.add('selected');
            if(ok){
              chosen.classList.add('correct');
              feedbackEl.className = 'feedback good';
              feedbackEl.textContent = '✔ Correct!';
            } else {
              chosen.classList.add('incorrect');
              feedbackEl.className = 'feedback bad';
              feedbackEl.innerHTML = `✖ Incorrect. ${q.explain}`;
              [...optionsEl.children].forEach((c,ci)=>{ if(q.options[ci].ok) c.classList.add('correct'); });
            }
          }
        }

        backBtn.disabled = idx===0;
        const last = idx===total-1;
        nextBtn.style.display = last ? 'none':'inline-block';
        finishBtn.style.display = last ? 'inline-block':'none';
        summaryBox.style.display = 'none';
      }

      function showSummary(){
        const total = session.questions.length;
        const correct = session.correctness.filter(x=>x===true).length;
        const wrong = total - correct;
        sumTotal.textContent = total;
        sumCorrect.textContent = correct;
        sumWrong.textContent = wrong;

        wrongList.innerHTML = '';
        const catCount = {};
        session.questions.forEach((q, i)=>{
          if(session.correctness[i]===false){
            const li = document.createElement('li');
            const chosenIdx = session.answers[i];
            const chosen = chosenIdx!=null ? q.options[chosenIdx].t : '(no answer)';
            const correctText = q.options.find(o=>o.ok).t;
            li.innerHTML = `<div style="margin-bottom:6px"><b>Q${i+1} — ${q.category}</b></div>
                            <div><i>Prompt:</i> ${q.prompt}</div>
                            ${q.type==='signal' ? `<div class="img-wrap" style="margin:8px 0"><img src="${q.image}" alt="signal" style="max-width:220px;max-height:140px"></div>`:''}
                            <div style="margin:4px 0">Your answer: <span class="bad">${chosen}</span></div>
                            <div>Correct answer: <span class="good">${correctText}</span></div>
                            <div style="margin-top:4px">${q.explain}</div>`;
            wrongList.appendChild(li);
            catCount[q.category] = (catCount[q.category]||0)+1;
          }
        });

        catList.innerHTML = '';
        Object.entries(catCount).sort((a,b)=>b[1]-a[1]).forEach(([cat,cnt])=>{
          const li = document.createElement('li');
          li.textContent = `${cat} — ${cnt} question(s) to review`;
          catList.appendChild(li);
        });

        progressBar.style.width = '100%';
        summaryBox.style.display = 'block';
        qText.textContent = 'Quiz complete!';
        optionsEl.innerHTML = '';
        imageZone.style.display = 'none';
        feedbackEl.textContent = '';
        backBtn.disabled = true;
        nextBtn.style.display = 'none';
        finishBtn.style.display = 'none';

        session.finished = true;
        saveSession(session);
      }

      // Buttons
      document.getElementById('backBtn').addEventListener('click',()=>{
        if(session.i>0){ session.i--; saveSession(session); render(); }
      });
      document.getElementById('nextBtn').addEventListener('click',()=>{
        if(session.answers[session.i]===null){
          feedbackEl.className = 'feedback bad';
          feedbackEl.textContent = 'Please choose an answer before continuing.';
          return;
        }
        if(session.i < session.questions.length-1){ session.i++; saveSession(session); render(); }
      });
      document.getElementById('finishBtn').addEventListener('click',()=>{
        if(session.answers[session.i]===null){
          feedbackEl.className = 'feedback bad';
          feedbackEl.textContent = 'Please choose an answer before finishing.';
          return;
        }
        showSummary();
      });
      document.getElementById('resetBtn').addEventListener('click',()=>{
        if(confirm('Reset quiz? This clears saved answers and reshuffles questions.')){
          clearSession(); location.reload();
        }
      });

      // Start
      render();
    })();
    </script>
  </main>
</body>
</html>