<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FIBA 3x3 Rules — Training Quiz</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --card:#0b1220; --accent:#22d3ee; --correct:#16a34a; --wrong:#ef4444;
    --text:#e5e7eb; --text-weak:#cbd5e1; --chip:#1f2937; --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:linear-gradient(180deg,#0a0f1e, #0f172a 40%, #0b1220); color:var(--text);}
  header{position:sticky; top:0; z-index:9; background:rgba(15,23,42,.85); backdrop-filter: blur(6px); border-bottom:1px solid var(--border)}
  .wrap{max-width:900px; margin:0 auto; padding:16px}
  h1{margin:0; font-size:20px; letter-spacing:.2px}
  .subtitle{color:var(--muted); font-size:13px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px}
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{appearance:none; border:1px solid var(--border); background:#0a0f1e; color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn:hover{border-color:#2b3447}
  .btn.primary{background:var(--accent); color:#001219; border-color:transparent}
  .btn.ghost{background:transparent}
  .btn.small{padding:7px 10px; font-size:14px}
  .pill{padding:4px 10px; border-radius:999px; background:var(--chip); color:var(--text-weak); border:1px solid var(--border); font-size:12px}
  .q-meta{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:13px}
  .stem{font-size:18px; margin:8px 0 10px}
  .context{color:var(--muted); font-size:14px; margin:0 0 12px}
  .choices{display:grid; gap:10px; margin-top:10px}
  .choice{border:1px solid var(--border); border-radius:12px; padding:10px 12px; cursor:pointer; background:#0b1220}
  .choice:hover{border-color:#2b3447}
  .choice.selected{outline:2px solid #334155}
  .choice.correct{background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.4)}
  .choice.wrong{background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.4)}
  .feedback{margin-top:12px; padding:10px 12px; border-radius:12px; font-size:14px}
  .ok{background: rgba(22,163,74,.13); border:1px solid rgba(22,163,74,.35)}
  .no{background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35)}
  .nav{display:flex; justify-content:space-between; margin-top:14px}
  .counter{font-size:13px; color:var(--muted)}
  .imgwrap{margin:auto 0 auto; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#020617}
  .imgwrap img{display:block; width:75%; height:75%}
  .summary{display:none}
  .summary table{width:100%; border-collapse:collapse}
  .summary th, .summary td{border-bottom:1px solid var(--border); text-align:left; padding:8px}
  .tag{font-size:12px; color:#a5b4fc; padding:2px 8px; border:1px solid #3730a3; border-radius:999px; background:#11103a}
  .note{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div>
        <h1>FIBA 3x3 Rules — Training Quiz</h1>
  </header>

  <div class="wrap">
    <div id="screen-quiz" class="card">
      <div class="row" style="justify-content:space-between">
        <div class="q-meta"><span class="pill" id="topic-pill">Topic</span> <span class="counter" id="progress">Question 1 / N</span></div>
        <div class="row">
          <button id="back" class="btn ghost small">◀ Back</button>
          <button id="skip" class="btn ghost small">Skip</button>
        </div>
      </div>

      <div id="image-area" class="imgwrap" style="display:none"><img id="q-image" alt="Referee signal"/></div>
      <div id="stem" class="stem"></div>
      <div id="context" class="context"></div>

      <div id="choices" class="choices"></div>

      <div id="feedback" class="feedback" style="display:none"></div>

      <div class="nav">
        <div class="counter" id="answered"></div>
        <button id="next" class="btn primary">Next ▶</button>
      </div>
    </div>

    <div id="screen-summary" class="card summary">
      <h2 style="margin:0 0 8px">Summary</h2>
      <p class="muted" id="scoreline"></p>
      <div id="weakness"></div>
      <h3 style="margin:14px 0 6px">Incorrect & Skipped</h3>
      <div id="wrong-list"></div>
      <div class="row" style="margin-top:12px">
        <button id="again" class="btn">Try again (reshuffle)</button>
        <button id="review-wrong" class="btn ghost">Review wrong only</button>
      </div>
    </div>
  </div>

<script>
/* ==============================
   QUESTION BANK
   ============================== */

/* Referee Signal Images: exact filenames (1–20, 31–56). Signals 21–30 do not exist. */
const SIGNAL_FILES = [
  "1. Stop the clock.jpeg","2. Stop the clock for foul.jpeg","3. 1 Point.jpeg","4. 2 points.jpeg","5. Charged time-out.jpeg","6. TV time-out.jpeg","7. Cancel score, cancel play.jpeg","8. Visible count.jpeg","9. Communication.jpeg","10. Shot clock reset.jpeg",
  "11. Out-of-bounds.jpeg","12. Held ball:jump ball situation.jpeg","13. Travelling.jpeg","14. Illegal Dribble_Double dribbling.jpeg","15. Illegal dribble_Carrying the ball.jpeg","16. 3 seconds.jpeg","17. 5 seconds.jpeg","18. 12 seconds.jpeg","19. Deliberate kick or block of the ball.jpeg","20. Ball not cleared.jpeg",
  "31. Holding.jpeg","32. Blocking (defense)_Illegal screen (offense).jpeg","33. Pushing or charging without the ball.jpeg","34. Handchecking.jpeg","35. Illegal use of hands.jpeg","36. Charging with the ball.jpeg","37. Illegal contact to the hand.jpeg","38. Hooking.jpeg","39. Excessive swinging of the elbow.jpeg","40. Hit to the head.jpeg",
  "41. Foul by team in control of the ball.jpeg","42. Foul on the act of shooting.jpeg","43. Foul not on the act of shooting.jpeg","44. Double foul.jpeg","45. Technical foul.jpeg","46. Unsportsmanlike foul.jpeg","47. Disqualifying foul.jpeg","48. Fake a foul.jpeg","49. IRS review.jpeg","50. Challenge.jpeg",
  "51. After foul without free throw(s).jpeg","52. After foul by team in control of the ball.jpeg","53. 1 free throw.jpeg","54. 2 free throws.jpeg","55. 1 free throw.jpeg","56. 2 free throws.jpeg"
];

/* Helper to infer label from filename */
function prettySignalName(file){
  return file.replace(/^\d+\.\s*/, '').replace(/\.(jpe?g|png|gif)$/i,'').trim();
}

/* Usage options for signals (1 correct + 3 plausible distractors) */
function usageOptions(name){
  const n = name.toLowerCase();
  if(n.includes('stop the clock for foul')) return {correct:"Stop the game clock after a foul is called", d:["Stop the clock for substitutions only","Indicate a charged time-out","Acknowledge a successful basket"]};
  if(n === 'stop the clock') return {correct:"Stop the game clock for reasons other than a foul", d:["Indicate a technical foul","Signal a TV time-out","Validate a 2-point goal"]};
  if(n.includes('1 point')) return {correct:"Validate a successful 1-point goal/free throw", d:["Validate a 2-point goal","Reset the shot clock to 12 seconds","Indicate a time-out"]};
  if(n.includes('2 points')) return {correct:"Validate a successful 2-point goal", d:["Validate a 1-point goal","Announce a substitution","Indicate a jump ball situation"]};
  if(n.includes('charged time-out')) return {correct:"Grant a team-requested 30-second time-out", d:["Announce a TV time-out","Grant a substitution","Cancel a play"]};
  if(n.includes('tv time-out')) return {correct:"Announce an automatic media time-out per timing rules", d:["Grant a team-requested time-out","Warn a bench for delay","Indicate end of period"]};
  if(n.includes('cancel score')) return {correct:"Cancel a basket or nullify a play", d:["Confirm the score","Indicate offensive control foul","Announce overtime"]};
  if(n.includes('visible count')) return {correct:"Display a visible count (e.g., 5 seconds or late 12 seconds)", d:["Start the game clock","Reset the shot clock","Signal 3 seconds"]};
  if(n.includes('communication')) return {correct:"Acknowledge communication or indicate 'OK'", d:["Grant a time-out","Call a technical foul","Indicate an IRS review"]};
  if(n.includes('shot clock reset')) return {correct:"Indicate that the shot clock is reset to 12 seconds", d:["Start a 5-second count","Indicate a jump ball situation","Signal ball out-of-bounds"]};
  if(n.includes('out-of-bounds')) return {correct:"Indicate the ball or player is out of bounds", d:["Signal a travel","Signal a double dribble","Cancel a goal"]};
  if(n.includes('held ball')||n.includes('jump ball')) return {correct:"Indicate a held-ball/jump-ball situation", d:["Grant a time-out","Charge a technical foul","Validate a field goal"]};
  if(n.includes('travelling')) return {correct:"Indicate a travelling violation", d:["Indicate 3 seconds","Indicate 12 seconds","Indicate an illegal dribble"]};
  if(n.includes('double dribbling')) return {correct:"Indicate an illegal second dribble", d:["Indicate carrying the ball","Indicate travelling","Indicate offensive goaltending"]};
  if(n.includes('carrying')) return {correct:"Indicate carrying/palming the ball", d:["Indicate double dribble","Indicate travelling","Indicate 5 seconds closely guarded"]};
  if(n.includes('3 seconds')) return {correct:"Indicate a 3-second restricted area violation", d:["Indicate 5 seconds closely guarded","Indicate 12 seconds shot clock","Indicate back-to-the-basket"]};
  if(n.includes('5 seconds')) return {correct:"Indicate 5 seconds (closely guarded) violation", d:["Indicate 3 seconds","Indicate 12 seconds","Indicate illegal screen"]};
  if(n.includes('12 seconds')) return {correct:"Indicate 12 seconds shot-clock violation", d:["Indicate 5 seconds closely guarded","Indicate 3 seconds","Indicate time-out granted"]};
  if(n.includes('deliberate kick')||n.includes('block of the ball')) return {correct:"Indicate deliberate kick or leg block of the ball", d:["Indicate interference","Indicate goaltending","Indicate carrying"]};
  if(n.includes('ball not cleared')) return {correct:"Indicate a no-clear violation (shot before clearing behind arc)", d:["Indicate backcourt violation","Indicate lane violation","Indicate substitution"]};
  if(n.includes('holding')) return {correct:"Indicate a holding foul", d:["Indicate a blocking foul","Indicate a travel","Indicate a double dribble"]};
  if(n.includes('blocking')||n.includes('illegal screen')) return {correct:"Indicate blocking on defense or illegal screen on offense", d:["Indicate charging","Indicate handchecking","Indicate out-of-bounds"]};
  if(n.includes('pushing or charging without the ball')) return {correct:"Indicate pushing/charging without the ball", d:["Indicate goaltending","Indicate technical foul","Indicate 5 seconds"]};
  if(n.includes('handchecking')) return {correct:"Indicate handchecking", d:["Indicate holding","Indicate blocking","Indicate time-out"]};
  if(n.includes('illegal use of hands')) return {correct:"Indicate illegal use of hands", d:["Indicate travel","Indicate ball out-of-bounds","Indicate challenge"]};
  if(n.includes('charging with the ball')) return {correct:"Indicate charging (player with the ball)", d:["Indicate blocking","Indicate double foul","Indicate 12 seconds"]};
  if(n.includes('illegal contact to the hand')) return {correct:"Indicate illegal contact to the hand (not the ball)", d:["Indicate legal play","Indicate travel","Indicate out-of-bounds"]};
  if(n.includes('hooking')) return {correct:"Indicate hooking by the offensive player", d:["Indicate blocking","Indicate goaltending","Indicate lane violation"]};
  if(n.includes('excessive swinging')) return {correct:"Indicate excessive swinging of elbows", d:["Indicate travel","Indicate technical for delay","Indicate out-of-bounds"]};
  if(n.includes('hit to the head')) return {correct:"Indicate illegal contact to the head", d:["Indicate play-on advantage","Indicate travel","Indicate goaltending"]};
  if(n.includes('foul by team in control')) return {correct:"Indicate a foul by the team in control of the ball (offensive)", d:["Indicate defensive foul on shot","Indicate double foul","Indicate technical foul only"]};
  if(n.includes('foul on the act of shooting')) return {correct:"Indicate a foul on a shooter (in the act of shooting)", d:["Indicate non-shooting foul","Indicate travel","Indicate jump ball"]};
  if(n.includes('foul not on the act')) return {correct:"Indicate a non-shooting foul", d:["Indicate act-of-shooting foul","Indicate travel","Indicate technical"]};
  if(n.includes('double foul')) return {correct:"Indicate a double foul by opponents at about the same time", d:["Indicate unsportsmanlike foul","Indicate technical foul","Indicate time-out"]};
  if(n.includes('technical foul')) return {correct:"Indicate a technical foul (behavioural, non-contact)", d:["Indicate unsportsmanlike foul","Indicate double foul","Indicate travel"]};
  if(n.includes('unsportsmanlike foul')) return {correct:"Indicate an unsportsmanlike foul (excessive/hard/dangerous)", d:["Indicate technical foul","Indicate double foul","Indicate jump ball"]};
  if(n.includes('disqualifying foul')) return {correct:"Indicate a disqualifying foul (flagrant unsportsmanlike action)", d:["Indicate unsportsmanlike only","Indicate technical only","Indicate goaltending"]};
  if(n.includes('fake a foul')) return {correct:"Indicate a fake being fouled", d:["Indicate legal guarding","Indicate time-out","Indicate substitution"]};
  if(n.includes('irs review')) return {correct:"Indicate an Instant Replay System review", d:["Indicate coach challenge denied","Indicate 2 points validated","Indicate media time-out"]};
  if(n.includes('challenge')) return {correct:"Indicate a team-initiated challenge", d:["Indicate IRS by officials only","Indicate double foul","Indicate 3 seconds"]};
  if(n.includes('after foul without free throw')) return {correct:"Indicate resumption after a foul without free throws (check-ball)", d:["Indicate 1 free throw","Indicate 2 free throws","Indicate technical foul"]};
  if(n.includes('after foul by team in control')) return {correct:"Indicate resumption after offensive team-control foul", d:["Indicate defensive shooting foul","Indicate double foul","Indicate TV time-out"]};
  if(n.match(/(^|[^0-9])1 free throw/)) return {correct:"Indicate penalty of 1 free throw", d:["Indicate 2 free throws","Indicate check-ball only","Indicate 2 FTs + possession"]};
  if(n.match(/(^|[^0-9])2 free throws/)) return {correct:"Indicate penalty of 2 free throws", d:["Indicate 1 free throw","Indicate check-ball only","Indicate technical (1 FT)"]};
  return {correct:"Use as indicated for this specific referee signal", d:["Grant a time-out","Reset the shot clock","Start a visible count"]};
}

/* Two questions per signal: identify (T1) + usage (T2) */
const SIGNAL_QUESTIONS = SIGNAL_FILES.flatMap((file, idx) => {
  const name = prettySignalName(file);
  const u = usageOptions(name);
  const img = 'images/' + file;

  // T1 Identify
  const idQ = {
    id:`sig-${idx+1}-a`,
    topic:'Referees & Officials',
    taxonomy:'T1',
    stem:'Identify this referee signal.',
    context:null,
    image:img,
    choices: unique(['Stop the clock','TV time-out','Visible count', name]), // ensure correct present
    answer: null, explain:`Signal: ${name}.`
  };
  idQ.choices = shuffle(idQ.choices);
  idQ.answer = idQ.choices.indexOf(name);

  // T2 Usage
  const usageChoices = shuffle([u.correct, ...u.d]);
  const useQ = {
    id:`sig-${idx+1}-b`,
    topic:'Referees & Officials',
    taxonomy:'T2',
    stem:'When is this signal used?',
    context:null,
    image:img,
    choices: usageChoices,
    answer: usageChoices.indexOf(u.correct),
    explain:`Usage: ${u.correct}.`
  };

  return [idQ, useQ];
});

/* Hand-written rules questions (T1/T2), concise stems & relevant distractors */
const RULE_QUESTIONS = [
  /* Playing Court & Equipment */
  {id:'pc-1', topic:'Playing Court & Equipment', taxonomy:'T1',
   stem:'What are the official FIBA 3x3 court dimensions measured from the inner edge of the boundary line?',
   context:null,
   choices:['15 m wide × 11 m long','28 m × 15 m','14 m × 15 m','16 m × 11 m'],
   answer:0, explain:'3x3 court: 15 m width, 11 m length.'},
  {id:'pc-2', topic:'Playing Court & Equipment', taxonomy:'T1',
   stem:'What is the radius of the two-point arc in FIBA 3x3?',
   context:null,
   choices:['6.75 m','6.25 m','7.00 m','6.50 m'],
   answer:0, explain:'Arc radius is 6.75 m.'},
  {id:'pc-3', topic:'Playing Court & Equipment', taxonomy:'T2',
   stem:'A venue adapts court markings for a grassroots event. What is correct under FIBA 3x3?',
   context:'Limited space at a community tournament.',
   choices:[
     'Adaptation of markings is allowed at grassroots level',
     'Official events may also ignore the arc distance',
     'Lines can be any width if visible',
     'No shot clock is allowed at grassroots level'
   ],
   answer:0, explain:'Adaptation allowed for grassroots; official competitions must fully comply.'},

  /* Teams & Uniforms */
  {id:'tm-1', topic:'Teams & Uniforms', taxonomy:'T1',
   stem:'How many team members are permitted on a FIBA 3x3 team roster for a game?',
   context:null,
   choices:['4 (3 players + 1 substitute)','5 (3 players + 2 substitutes)','3 only','6 including a coach'],
   answer:0, explain:'Max 4 entitled to play.'},
  {id:'tm-2', topic:'Teams & Uniforms', taxonomy:'T2',
   stem:'Two teammates wear the same jersey number. What should apply?',
   context:'Pre-game check.',
   choices:[
     'Players on the same team must wear different numbers',
     'Identical numbers are allowed if different colours',
     'Numbers are optional in 3x3',
     'Only the front number must differ'
   ],
   answer:0, explain:'Same number not allowed.'},

  /* Playing Regulations */
  {id:'pr-1', topic:'Playing Regulations', taxonomy:'T1',
   stem:'How long is regular playing time in FIBA 3x3 official competitions?',
   context:null,
   choices:['1 period of 10 minutes','4 periods of 10 minutes','2 halves of 10 minutes','1 period of 12 minutes'],
   answer:0, explain:'One period of 10 minutes.'},
  {id:'pr-2', topic:'Playing Regulations', taxonomy:'T2',
   stem:'The score is tied at the end of regular time. What decides the game in overtime?',
   context:'Start of OT.',
   choices:[
     'First team to score 2 points wins',
     'Three-minute extra period',
     'First team to reach 25 points wins',
     'Jump ball then play to horn'
   ],
   answer:0, explain:'OT: first to 2 points.'},
  {id:'pr-3', topic:'Playing Regulations', taxonomy:'T2',
   stem:'After a defensive rebound, the player shoots immediately from inside the arc without clearing. What is the correct ruling?',
   context:'Ball not cleared behind the arc.',
   choices:[
     'No-clear violation; cancel potential field goal; opponents get check-ball',
     'Play-on if shot hits ring',
     'Travel violation on rebounder',
     'Double-dribble violation on rebounder'
   ],
   answer:0, explain:'Defense must clear before attempting to score.'},

  /* Violations */
  {id:'vi-1', topic:'Violations', taxonomy:'T1',
   stem:'During a dribble, which action makes it an illegal carry?',
   context:null,
   choices:[
     'Placing the hand under the ball and bringing it to a pause',
     'Changing hands while dribbling',
     'Taking steps while the ball is in the air',
     'Starting a dribble after a deflection'
   ],
   answer:0, explain:'Hand under the ball + pause = carry.'},
  {id:'vi-2', topic:'Violations', taxonomy:'T2',
   stem:'An offensive player stands in the restricted area while his team controls the ball. After about three seconds, he begins to exit the lane. What is correct?',
   context:'Lane occupancy and allowances.',
   choices:[
     'No violation if he is making an attempt to leave',
     '3-second violation immediately at 3.0 seconds',
     'Violation only if defender is present',
     'Reset when ball is passed to perimeter'
   ],
   answer:0, explain:'Allowance is made when attempting to leave.'},
  {id:'vi-3', topic:'Violations', taxonomy:'T2',
   stem:'Near the end of the shot clock, the ball is released and misses the ring. The defense secures clear control immediately. What is correct?',
   context:'End-of-12-second situation.',
   choices:[
     'Disregard the horn; play continues with defense control',
     'Shot-clock violation; check-ball to defense',
     'Jump ball situation',
     'Reset to 12 and offense keeps the ball'
   ],
   answer:0, explain:'If opponents gain immediate and clear control, disregard the horn and continue.'},

  /* Fouls */
  {id:'fl-1', topic:'Fouls', taxonomy:'T1',
   stem:'At team foul 7, what is the penalty for a common non-shooting foul?',
   context:null,
   choices:['Two free throws','One free throw','Check-ball only','Two free throws and possession'],
   answer:0, explain:'Team fouls 7–9 = 2 FTs.'},
  {id:'fl-2', topic:'Fouls', taxonomy:'T2',
   stem:'A defender commits excessive contact on a drive. It is the defender’s first such foul. What penalty applies?',
   context:'Forceful contact with risk.',
   choices:[
     'Unsportsmanlike foul: 2 free throws (no possession); if goal made: count + 2 FTs',
     'Technical foul: 1 free throw',
     'Disqualifying foul automatically',
     'Personal foul only; check-ball'
   ],
   answer:0, explain:'Unsportsmanlike first U = 2 FTs; if in act & made, count + 2 FTs.'},
  {id:'fl-3', topic:'Fouls', taxonomy:'T2',
   stem:'Two opponents commit contact fouls on each other at about the same time. What is the ruling?',
   context:'Simultaneous contact by opponents.',
   choices:[
     'Double foul; no free throws; resume per status (e.g., last defense check-ball)',
     'Technical fouls for both',
     'Jump ball with arrow',
     'Two free throws for both players'
   ],
   answer:0, explain:'Double foul: record both; no FTs; resume based on prior status.'},

  /* Referees & Officials (non-image) */
  {id:'of-1', topic:'Referees & Officials', taxonomy:'T1',
   stem:'How many referees officiate a FIBA 3x3 game?',
   context:null,
   choices:['Two referees','One referee','Three referees','Two plus a crew chief'],
   answer:0, explain:'Two referees.'},
  {id:'of-2', topic:'Referees & Officials', taxonomy:'T2',
   stem:'What can a team request a video Challenge for near the end of the game?',
   context:'IRS available.',
   choices:[
     'Whether a last shot beat the shot clock and/or counts for 1 or 2 points',
     'Any no-call anywhere on the floor',
     'A routine substitution question',
     'Whether a coach may call time-out during live ball'
   ],
   answer:0, explain:'Challengeable items include last-shot timing/value (plus other specified cases).'}
];

/* Final pool */
const QUESTIONS = [...RULE_QUESTIONS, ...SIGNAL_QUESTIONS];

/* ==============================
   QUIZ ENGINE
   ============================== */

const STORAGE_KEY = 'fiba3x3_quiz_state_v2';

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function unique(arr){ return [...new Set(arr)]; }
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

let order = [];
let pool = [];
let idx = 0;
let answers = {};
let wrong = new Set();

function buildPool(){
  const raw = QUESTIONS;
  pool = shuffle(raw).map(q=>{
    const qq = deepClone(q);
    const pairs = q.choices.map((c,i)=>({c,i}));
    const mixed = shuffle(pairs);
    qq.choices = mixed.map(p=>p.c);
    qq.answer = mixed.findIndex(p=>p.i===q.answer);
    return qq;
  });
  order = [...pool.keys()];
  idx = 0;
}

function saveState(){
  const state = {answers, idx, order};
  sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadState(){
  const s = sessionStorage.getItem(STORAGE_KEY);
  if(!s) return false;
  try{
    const state = JSON.parse(s);
    buildPool();
    if(Array.isArray(state.order) && state.order.length===order.length){ order = state.order; }
    idx = Math.min(Math.max(0, state.idx||0), order.length-1);
    answers = state.answers||{};
    Object.keys(answers).forEach(id=>{ if(!answers[id].correct) wrong.add(id); });
    return true;
  }catch(e){ return false; }
}

function startQuiz(resetAnswers=true){
  buildPool();
  if(resetAnswers){ answers={}; wrong.clear(); sessionStorage.removeItem(STORAGE_KEY); }
  document.getElementById('screen-quiz').style.display='';
  document.getElementById('screen-summary').style.display='none';
  updateUI();
  saveState();
}

function currentQ(){
  const i = order[idx] ?? 0;
  return pool[i];
}

function updateUI(){
  const q = currentQ();
  if(!q){ showSummary(); return; }
  document.getElementById('progress').textContent = `Question ${idx+1} / ${order.length}`;
  document.getElementById('topic-pill').textContent = q.topic;

  const imgWrap = document.getElementById('image-area');
  if(q.image){ imgWrap.style.display='block'; document.getElementById('q-image').src = q.image; document.getElementById('q-image').alt = 'Signal image'; }
  else { imgWrap.style.display='none'; }

  document.getElementById('stem').textContent = q.stem;
  document.getElementById('context').textContent = q.context || '';

  const choices = document.getElementById('choices');
  choices.innerHTML='';
  q.choices.forEach((text,i)=>{
    const d=document.createElement('div');
    d.className='choice';
    d.textContent = text;
    d.onclick=()=>selectChoice(i);
    choices.appendChild(d);
  });

  const prev = answers[q.id];
  const feedback = document.getElementById('feedback');
  feedback.style.display='none';
  feedback.className='feedback';
  feedback.textContent='';

  if(prev){
    markChoices(prev.choice, q.answer);
    feedback.style.display='block';
    feedback.classList.add(prev.correct?'ok':'no');
    feedback.innerHTML = (prev.correct?'✔ Correct. ':'✖ Incorrect. ') + `<span class="muted">${q.explain}</span>`;
  }

  document.getElementById('back').disabled = (idx===0);
  document.getElementById('answered').textContent = `${Object.keys(answers).length} answered`;
}

function markChoices(sel, correct){
  const nodes = [...document.querySelectorAll('.choice')];
  nodes.forEach((n,i)=>{
    n.classList.toggle('selected', i===sel);
    n.classList.toggle('correct', i===correct);
    n.classList.toggle('wrong', i===sel && sel!==correct);
  });
}

function selectChoice(i){
  const q = currentQ();
  const isCorrect = (i===q.answer);
  answers[q.id] = {choice:i, correct:isCorrect};
  if(!isCorrect){ wrong.add(q.id); } else { wrong.delete(q.id); }
  const feedback = document.getElementById('feedback');
  markChoices(i, q.answer);
  feedback.style.display='block';
  feedback.className='feedback ' + (isCorrect?'ok':'no');
  feedback.innerHTML = (isCorrect?'✔ Correct. ':'✖ Incorrect. ') + `<span class="muted">${q.explain}</span>`;
  saveState();
}

function nextQ(){
  if(idx < order.length-1){ idx++; updateUI(); saveState(); }
  else { showSummary(); }
}
function backQ(){
  if(idx>0){ idx--; updateUI(); saveState(); }
}
function skipQ(){ nextQ(); }

function showSummary(){
  document.getElementById('screen-quiz').style.display='none';
  const sum = document.getElementById('screen-summary');
  sum.style.display='block';

  const total = order.length;
  const correct = Object.values(answers).filter(a=>a.correct).length;
  document.getElementById('scoreline').textContent = `You answered ${correct} of ${total} correctly.`;

  // Weak topics
  const byTopic = {};
  order.forEach((ordIdx)=>{
    const q = pool[ordIdx];
    const a = answers[q.id];
    if(!byTopic[q.topic]) byTopic[q.topic] = {total:0, wrong:0};
    byTopic[q.topic].total++;
    if(!a || !a.correct) byTopic[q.topic].wrong++;
  });
  const weakWrap = document.getElementById('weakness');
  const topicList = Object.entries(byTopic).map(([t,s])=>{
    const pct = Math.round(100*(s.total - s.wrong)/s.total);
    return `<span class="tag" title="${s.total-s.wrong}/${s.total}">${t}: ${pct}%</span>`;
  }).join(' ');
  weakWrap.innerHTML = `<div class="row" style="flex-wrap:wrap; gap:8px; margin:10px 0">${topicList}</div>`;

  // Wrong / skipped list
  const wrongWrap = document.getElementById('wrong-list');
  const rows = order.map(i=>{
    const q = pool[i], a = answers[q.id];
    if(a && a.correct) return '';
    const your = a? q.choices[a.choice] : '<i>Skipped</i>';
    const correctTxt = q.choices[q.answer];
    const img = q.image? `<div class="imgwrap" style="margin-top:8px"><img src="${q.image}" alt=""></div>` : '';
    return `
      <div class="card" style="padding:12px; margin:10px 0">
        <div class="q-meta"><span class="pill">${q.topic}</span></div>
        <div class="stem">${q.stem}</div>
        ${q.context?`<div class="context">${q.context}</div>`:''}
        ${img}
        <div class="muted">Your answer: ${your}</div>
        <div>Correct: <strong>${correctTxt}</strong></div>
        <div class="note" style="margin-top:6px">${q.explain}</div>
      </div>`;
  }).filter(Boolean).join('');
  wrongWrap.innerHTML = rows || '<p class="muted">Nice—no incorrect answers.</p>';
}

/* Buttons */
document.getElementById('next').onclick = nextQ;
document.getElementById('back').onclick = backQ;
document.getElementById('skip').onclick = skipQ;
document.getElementById('restart').onclick = ()=>{ sessionStorage.removeItem(STORAGE_KEY); startQuiz(true); };
document.getElementById('again').onclick = ()=>{ sessionStorage.removeItem(STORAGE_KEY); startQuiz(true); };
document.getElementById('review-wrong').onclick = ()=>{
  const wrongIds = new Set(Object.keys(answers).filter(id=>!answers[id].correct));
  if(!wrongIds.size){ startQuiz(true); return; }
  pool = pool.filter(q=>wrongIds.has(q.id));
  order = [...pool.keys()];
  idx=0;
  sessionStorage.removeItem(STORAGE_KEY);
  updateUI();
};

/* Init */
if(!loadState()){ startQuiz(true); }
</script>
</body>
</html>
